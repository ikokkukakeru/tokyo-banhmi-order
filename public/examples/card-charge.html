<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TOKYO BANH MI STAND - ご注文</title>
    <link href="/app.css" rel="stylesheet" />
    <style>
      /* TOKYO BANH MI STAND - Vietnamese sandwich shop theme */
      :root {
        --banhmi-orange: #E85D04;
        --banhmi-orange-light: #F48C06;
        --banhmi-orange-dark: #D00000;
        --banhmi-green: #2D6A4F;
        --banhmi-green-light: #40916C;
        --banhmi-green-pale: #95D5B2;
        --banhmi-cream: #FFF8F0;
        --banhmi-white: #FFFFFF;
        --banhmi-brown: #6B4423;
      }

      body.banhmi-page {
        font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
        background: linear-gradient(135deg, var(--banhmi-cream) 0%, #FFE5D9 50%, #E8F5E9 100%);
        margin: 0;
        min-height: 100vh;
        padding: 24px 16px;
      }

      .banhmi-container {
        max-width: 480px;
        margin: 0 auto;
      }

      .banhmi-header {
        text-align: center;
        margin-bottom: 24px;
      }

      .banhmi-header h1 {
        font-size: 1.5rem;
        color: var(--banhmi-orange);
        margin: 0;
        font-weight: 700;
        letter-spacing: 0.05em;
      }

      .banhmi-header p {
        font-size: 0.85rem;
        color: var(--banhmi-brown);
        margin: 4px 0 0 0;
      }

      .product-card {
        background: var(--banhmi-white);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(232, 93, 4, 0.15);
        border: 2px solid var(--banhmi-green-pale);
      }

      .product-card .product-badge {
        display: inline-block;
        background: var(--banhmi-green);
        color: white;
        font-size: 0.7rem;
        padding: 4px 12px;
        border-radius: 20px;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .product-card .product-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--banhmi-brown);
        margin: 0 0 8px 0;
        line-height: 1.4;
      }

      .product-card .product-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--banhmi-orange);
        margin: 0 0 16px 0;
      }

      .product-card .product-description {
        font-size: 0.9rem;
        color: var(--banhmi-brown);
        line-height: 1.6;
        margin: 0;
        opacity: 0.9;
      }

      .payment-section {
        background: var(--banhmi-white);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 20px rgba(45, 106, 79, 0.12);
        border: 2px solid var(--banhmi-green-pale);
      }

      .payment-section h2 {
        font-size: 1rem;
        color: var(--banhmi-green);
        margin: 0 0 20px 0;
        font-weight: 600;
      }

      .menu-section {
        background: var(--banhmi-white);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(45, 106, 79, 0.12);
        border: 2px solid var(--banhmi-green-pale);
      }

      .menu-section h2 {
        font-size: 1rem;
        color: var(--banhmi-green);
        margin: 0 0 20px 0;
        font-weight: 600;
      }

      .menu-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 2px solid var(--banhmi-green-pale);
        border-radius: 12px;
        cursor: pointer;
        transition: border-color 0.2s, background 0.2s;
      }

      .menu-option:last-child {
        margin-bottom: 0;
      }

      .menu-option:hover {
        background: rgba(149, 213, 178, 0.2);
      }

      .banhmi-page .menu-loading,
      .banhmi-page .menu-error {
        color: var(--banhmi-brown);
        margin: 0;
        padding: 16px 0;
      }

      .banhmi-page .menu-error {
        color: var(--banhmi-orange-dark);
      }

      .menu-option.selected {
        border-color: var(--banhmi-orange);
        background: rgba(232, 93, 4, 0.08);
      }

      .menu-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin: 0;
        accent-color: var(--banhmi-orange);
      }

      .menu-option-label {
        flex: 1;
        cursor: pointer;
      }

      .menu-option-name {
        font-weight: 600;
        color: var(--banhmi-brown);
        font-size: 1rem;
      }

      .menu-option-price {
        font-weight: 700;
        color: var(--banhmi-orange);
        font-size: 1rem;
        margin-top: 4px;
      }

      .payment-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: rgba(45, 106, 79, 0.08);
        border-radius: 12px;
        margin-bottom: 20px;
        border: 2px solid var(--banhmi-green-pale);
      }

      .payment-total-label {
        font-weight: 600;
        color: var(--banhmi-green);
        font-size: 1rem;
      }

      .payment-total-amount {
        font-weight: 700;
        color: var(--banhmi-orange);
        font-size: 1.25rem;
      }

      .banhmi-page #payment-form {
        margin: 0;
        max-width: none;
      }

      .banhmi-page #card-container {
        margin-top: 0;
      }

      .order-info {
        margin-bottom: 20px;
      }

      .order-info label {
        display: block;
        font-weight: 600;
        color: var(--banhmi-green);
        font-size: 0.9rem;
        margin-bottom: 8px;
      }

      .order-info label .required {
        color: var(--banhmi-orange);
        margin-left: 4px;
      }

      .order-info input[type="text"],
      .order-info textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--banhmi-green-pale);
        border-radius: 12px;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s;
      }

      .order-info input[type="text"]:focus,
      .order-info textarea:focus {
        outline: none;
        border-color: var(--banhmi-orange);
      }

      .order-info textarea {
        min-height: 80px;
        resize: vertical;
      }

      .order-info .field-optional {
        color: var(--banhmi-brown);
        font-weight: 400;
        font-size: 0.8rem;
      }

      .postal-code-note {
        font-size: 0.8rem;
        color: var(--banhmi-brown);
        margin-bottom: 16px;
        padding: 8px 12px;
        background: rgba(45, 106, 79, 0.06);
        border-radius: 8px;
      }

      .banhmi-page #card-button {
        background: linear-gradient(135deg, var(--banhmi-orange) 0%, var(--banhmi-orange-dark) 100%);
        margin-top: 20px;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(232, 93, 4, 0.35);
      }

      .banhmi-page #card-button:hover {
        background: linear-gradient(135deg, var(--banhmi-orange-light) 0%, var(--banhmi-orange) 100%);
        box-shadow: 0 6px 16px rgba(232, 93, 4, 0.4);
      }

      .banhmi-page #card-button:active {
        background: var(--banhmi-orange-dark);
      }

      .banhmi-page #payment-status-container {
        margin-top: 20px;
        border-radius: 12px;
        border-color: var(--banhmi-green-pale);
      }

      .banhmi-page #payment-status-container.is-success {
        background: rgba(45, 106, 79, 0.08);
      }

      .banhmi-page #payment-status-container.is-failure {
        background: rgba(232, 93, 4, 0.08);
        width: auto;
        max-width: 100%;
        padding: 12px 16px;
      }

      .banhmi-page #payment-status-container.is-failure.has-custom-message:after {
        content: none;
      }

      .banhmi-page #success-view {
        display: none;
        background: var(--banhmi-white);
        border-radius: 16px;
        padding: 32px 24px;
        margin-top: 20px;
        box-shadow: 0 4px 20px rgba(45, 106, 79, 0.12);
        border: 2px solid var(--banhmi-green-pale);
        text-align: center;
      }

      .banhmi-page #success-view .success-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--banhmi-green);
        margin: 0 0 20px 0;
      }

      .banhmi-page #success-view .success-order-id {
        font-size: 0.95rem;
        color: var(--banhmi-brown);
        margin: 0 0 16px 0;
        word-break: break-all;
      }

      .banhmi-page #success-view .success-note {
        font-size: 0.9rem;
        color: var(--banhmi-brown);
        margin: 0;
        opacity: 0.9;
      }

      .banhmi-page input:focus {
        border-color: var(--banhmi-orange);
      }
    </style>
    <script
      type="text/javascript"
      src="https://sandbox.web.squarecdn.com/v1/square.js"
    ></script>
    <script>
      const appId = 'sandbox-sq0idb-oKEv1VNR-uF3ECUHWG5WCA';
      const locationId = 'LSB41KX7QNYRJ';

      // サーバーから取得したメニュー項目 { variationId, name, amount }
      let menuItems = [];

      function getSelectedAmount() {
        const selected = document.querySelector('input[name="menu-item"]:checked');
        return selected ? parseInt(selected.value, 10) : (menuItems[0]?.amount ?? 940);
      }

      function getSelectedProductName() {
        const selected = document.querySelector('input[name="menu-item"]:checked');
        if (!selected) return menuItems[0]?.name ?? '注文';
        const label = selected.closest('.menu-option');
        const nameEl = label?.querySelector('.menu-option-name');
        return nameEl ? nameEl.textContent : '注文';
      }

      function getSelectedVariationId() {
        const selected = document.querySelector('input[name="menu-item"]:checked');
        return selected?.dataset?.variationId ?? '';
      }

      function updatePaymentDisplay() {
        const amount = getSelectedAmount();
        const totalEl = document.getElementById('payment-total-amount');
        const btnEl = document.getElementById('card-button');
        if (totalEl) totalEl.textContent = `¥${amount.toLocaleString()}`;
        if (btnEl) btnEl.textContent = `¥${amount.toLocaleString()} で支払う`;
        document.querySelectorAll('.menu-option').forEach((el) => el.classList.remove('selected'));
        const checkedRadio = document.querySelector('input[name="menu-item"]:checked');
        if (checkedRadio) checkedRadio.closest('.menu-option').classList.add('selected');
      }

      function buildMenuItemsFromCatalog(objects) {
        const items = [];
        if (!Array.isArray(objects)) return items;
        for (const obj of objects) {
          if (obj.type !== 'ITEM' || !obj.item_data) continue;
          const variations = obj.item_data.variations;
          if (!variations || variations.length === 0) continue;
          const v0 = variations[0];
          const variationId = v0.id;
          const priceMoney = v0.item_variation_data?.price_money;
          const amount = priceMoney != null ? Number(priceMoney.amount) || 0 : 0;
          const name = (obj.item_data.name || '商品').trim();
          items.push({ variationId, name, amount });
        }
        return items;
      }

      function renderMenuList(items) {
        const container = document.getElementById('menu-list');
        if (!container) return;
        container.innerHTML = '';
        if (items.length === 0) {
          container.innerHTML = '<p class="menu-error">メニューを読み込めませんでした。</p>';
          return;
        }
        menuItems = items;
        items.forEach((item, index) => {
          const label = document.createElement('label');
          label.className = 'menu-option' + (index === 0 ? ' selected' : '');
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = 'menu-item';
          radio.value = String(item.amount);
          radio.dataset.variationId = item.variationId;
          if (index === 0) radio.checked = true;
          const wrap = document.createElement('span');
          wrap.className = 'menu-option-label';
          wrap.innerHTML = `<span class="menu-option-name">${escapeHtml(item.name)}</span><span class="menu-option-price">¥${item.amount.toLocaleString()}</span>`;
          label.appendChild(radio);
          label.appendChild(wrap);
          container.appendChild(label);
        });
        document.querySelectorAll('input[name="menu-item"]').forEach((radio) => {
          radio.addEventListener('change', updatePaymentDisplay);
        });
        updatePaymentDisplay();
      }

      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function loadAndRenderMenu() {
        const container = document.getElementById('menu-list');
        try {
          const res = await fetch('/api/items');
          const data = await res.json();
          if (!res.ok) throw new Error(data?.errors?.[0]?.detail || data?.error || 'Failed to load menu');
          const items = buildMenuItemsFromCatalog(data.objects || []);
          renderMenuList(items);
        } catch (e) {
          if (container) {
            container.innerHTML = '<p class="menu-error">メニューを読み込めませんでした。</p>';
          }
          console.error('Load menu error:', e);
          menuItems = [];
        }
      }

      async function initializeCard(payments) {
        const card = await payments.card();
        await card.attach('#card-container');

        return card;
      }

      const PAYMENT_REQUEST_TIMEOUT_MS = 25000;

      async function createPayment(token, amount, customerName, customerNotes, productName, catalogObjectId) {
        const payload = {
          locationId,
          sourceId: token,
          idempotencyKey: window.crypto.randomUUID(),
          amount,
          customerName: customerName?.trim() || '',
          customerNotes: customerNotes?.trim() || '',
          productName,
        };
        if (catalogObjectId) payload.catalog_object_id = catalogObjectId;
        const body = JSON.stringify(payload);

        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), PAYMENT_REQUEST_TIMEOUT_MS);

        let paymentResponse;
        try {
          paymentResponse = await fetch('/payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body,
            signal: controller.signal,
          });
        } catch (e) {
          if (e.name === 'AbortError') {
            throw new Error('通信がタイムアウトしました。しばらくして再度お試しください。');
          }
          throw new Error('通信エラーが発生しました。ネットワークを確認して再度お試しください。');
        } finally {
          clearTimeout(timeoutId);
        }

        if (paymentResponse.ok) {
          return paymentResponse.json();
        }

        const errorBody = await paymentResponse.text();
        let message = errorBody;
        try {
          const parsed = JSON.parse(errorBody);
          if (parsed && typeof parsed.error === 'string') message = parsed.error;
          else if (parsed && parsed.errors && Array.isArray(parsed.errors) && parsed.errors[0]?.detail) message = parsed.errors[0].detail;
        } catch (_) {}
        throw new Error(message);
      }

      // New payment flow
      async function tokenize(paymentMethod, amount) {
        const verificationDetails = {
          amount: String(amount),
          billingContact: {
            givenName: 'John',
            familyName: 'Doe',
            email: 'john.doe@square.example',
            phone: '3214563987',
            addressLines: ['123 Main Street', 'Apartment 1'],
            city: 'London',
            state: 'LND',
            countryCode: 'GB',
          },
          currencyCode: 'JPY',
          intent: 'CHARGE',
          customerInitiated: true,
          sellerKeyedIn: false,
        };
        const tokenResult = await paymentMethod.tokenize(verificationDetails);
        if (tokenResult.status === 'OK') {
          return tokenResult.token;
        } else {
          let errorMessage = `Tokenization failed with status: ${tokenResult.status}`;
          if (tokenResult.errors) {
            errorMessage += ` and errors: ${JSON.stringify(
              tokenResult.errors,
            )}`;
          }

          throw new Error(errorMessage);
        }
      }

      // status is either SUCCESS or FAILURE;
      function displayPaymentResults(status) {
        const statusContainer = document.getElementById(
          'payment-status-container',
        );
        if (status === 'SUCCESS') {
          statusContainer.classList.remove('is-failure', 'has-custom-message');
          statusContainer.classList.add('is-success');
          statusContainer.textContent = '';
        } else {
          statusContainer.classList.remove('is-success');
          statusContainer.classList.add('is-failure');
        }

        statusContainer.style.visibility = 'visible';
      }

      document.addEventListener('DOMContentLoaded', async function () {
        await loadAndRenderMenu();

        if (!window.Square) {
          throw new Error('Square.js failed to load properly');
        }

        let payments;
        try {
          payments = window.Square.payments(appId, locationId);
        } catch {
          const statusContainer = document.getElementById(
            'payment-status-container',
          );
          statusContainer.className = 'missing-credentials';
          statusContainer.style.visibility = 'visible';
          return;
        }

        let card;
        try {
          card = await initializeCard(payments);
        } catch (e) {
          console.error('Initializing Card failed', e);
          return;
        }

        async function handlePaymentMethodSubmission(event, card) {
          event.preventDefault();

          const customerNameInput = document.getElementById('customer-name');
          const customerNotesInput = document.getElementById('customer-notes');
          const customerName = customerNameInput?.value || '';
          const customerNotes = customerNotesInput?.value || '';

          if (!customerName.trim()) {
            customerNameInput?.focus();
            customerNameInput?.reportValidity?.();
            return;
          }

          const amount = getSelectedAmount();
          const productName = getSelectedProductName();

          const originalButtonText = cardButton.textContent;
          try {
            cardButton.disabled = true;
            cardButton.textContent = '処理中...';
            const token = await tokenize(card, amount);
            const catalogObjectId = getSelectedVariationId();
            const paymentResults = await createPayment(token, amount, customerName, customerNotes, productName, catalogObjectId);
            const orderId = paymentResults?.payment?.orderId || '';
            document.getElementById('payment-form').style.display = 'none';
            document.getElementById('payment-status-container').style.display = 'none';
            const successOrderIdEl = document.getElementById('success-order-id');
            if (successOrderIdEl) successOrderIdEl.textContent = orderId;
            document.getElementById('success-view').style.display = 'block';
            console.debug('Payment Success', paymentResults);
          } catch (e) {
            cardButton.disabled = false;
            cardButton.textContent = originalButtonText;
            displayPaymentResults('FAILURE');
            const statusContainer = document.getElementById('payment-status-container');
            const msg = e && e.message ? e.message : '決済に失敗しました。';
            statusContainer.textContent = msg;
            statusContainer.classList.add('has-custom-message');
            console.error(e && e.message ? e.message : e);
          }
        }

        const cardButton = document.getElementById('card-button');
        cardButton.addEventListener('click', async function (event) {
          await handlePaymentMethodSubmission(event, card);
        });

        updatePaymentDisplay();
      });
    </script>
  </head>
  <body class="banhmi-page">
    <div class="banhmi-container">
      <header class="banhmi-header">
        <h1>TOKYO BANH MI STAND</h1>
        <p>ベトナムサンドイッチ専門店</p>
      </header>

      <section class="menu-section">
        <h2>メニューを選択</h2>
        <div id="menu-list">
          <p class="menu-loading">メニューを読み込み中...</p>
        </div>
      </section>

      <section class="payment-section">
        <h2>お支払い情報</h2>
        <div class="payment-total">
          <span class="payment-total-label">支払合計金額</span>
          <span id="payment-total-amount" class="payment-total-amount">¥940</span>
        </div>
        <form id="payment-form">
          <div class="order-info">
            <label for="customer-name">お名前 <span class="required">（必須）</span></label>
            <input type="text" id="customer-name" name="customer-name" placeholder="受け取り時の名前" required maxlength="50" />
          </div>
          <div class="order-info">
            <label for="customer-notes">備考 <span class="field-optional">（任意）</span></label>
            <textarea id="customer-notes" name="customer-notes" placeholder="例：パクチー抜き、辛さ控えめ など"></textarea>
          </div>
          <p class="postal-code-note">※ カードの郵便番号は日本の形式（例：100-0001）でご入力ください。</p>
          <div id="card-container"></div>
          <button id="card-button" type="button">¥940 で支払う</button>
        </form>
        <div id="payment-status-container"></div>
        <div id="success-view">
          <p class="success-title">ご注文ありがとうございます！</p>
          <p class="success-order-id">注文ID: <span id="success-order-id"></span></p>
          <p class="success-note">カウンターでお待ちください</p>
        </div>
      </section>
    </div>
  </body>
</html>
